{"version":3,"sources":["../../../src/Bot/Features/Twibbon.js"],"names":["objectsHaveSameKeys","objects","allKeys","reduce","keys","object","concat","Object","union","Set","every","size","length","Twibbon","Bot","user","userId","origin","originId","getId","manual_transform","twibbon_overlay","filename","transformation","crop","width","height","format","public_id","overlay","flags","aspect_ratio","twibbon_list","id","category","name","url","transform","auto","gravity","Math","floor","manual","y","x","ready","args","data","SharedProps","set","twibbon","type","status","source","displayList","replyText","command_prefix","selected","filter","twibbonColumns","map","thumbnailImageUrl","imageBackgroundColor","text","actions","label","JSON","stringify","sendMessage","altText","template","columns","imageAspectRatio","imageSize","listenPostback","getProfile","then","profile","messages","displayName","push","getTransformedFileUrl","twibbonSetting","publicId","getTwibbonById","result","cloudinary","generate","Promise","resolve","reject","CloudinaryUtils","upload","twibbonBackgroundMeta","performTransformations","twibbonOriginalName","resultOriginalUrl","twibonPreviewName","resultPreviewUrl","all","fileMeta","twibbonOriginalUrl","secure_url","twibbonPreviewUrl","fs","unlinkSync","originalContentPath","previewPath","make","props","event","message","originalContentUrl","previewImageUrl","listenImage","getContent","store","userSwitch","userInSameCommunal","twibbonIdChosen","undefined"],"mappings":"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","file":"Twibbon.js","sourcesContent":["import { command_prefix, batch_list, baseURL, SharedProps } from \"../../Bot\";\nimport FEPStoreCRUD from \"../../Bot/Helper/FEPStoreCRUD\";\nimport CloudinaryUtils from \"../../Bot/Helper/CloudinaryUtils\";\nimport cloudinary from \"cloudinary\";\nimport fs from \"fs-extra\";\nimport request from \"request\";\nimport cp from \"child_process\";\nimport path from \"path\";\n\nconst objectsHaveSameKeys = (...objects) => {\n  const allKeys = objects.reduce((keys, object) => keys.concat(Object.keys(object)), []);\n  const union = new Set(allKeys);\n  return objects.every(object => union.size === Object.keys(object).length);\n};\n\nexport const Twibbon = Bot => {\n  const { user: userId, origin: originId } = Bot.getId();\n\n  const manual_transform = (twibbon_overlay, filename, size) => {\n    return {\n      transformation: [\n        {\n          crop: \"fit\",\n          width: size,\n          height: size,\n          format: \"jpg\",\n          public_id: `${filename}-twibbon`\n        }, {\n          overlay: twibbon_overlay,\n          flags: \"relative\",\n          width: size,\n          height: size,\n          aspect_ratio: \"1:1\"\n        }\n      ]\n    };\n  };\n\n  const twibbon_list = [{\n    id: \"twibbon_covid\",\n    category: \"covid\",\n    name: \"Covid #DiRumahAja\",\n    url: \"https://res.cloudinary.com/fep-bot/image/upload/v1585597597/twibbons/twibbon_covid.png\",\n    transform: (filename, size) => {\n      return {\n        auto: {\n          transformation: [\n            {\n              gravity: \"auto\",\n              crop: \"fill\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.255),\n              height: size - Math.floor(size * 0.255),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_covid.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        },\n        manual: {\n          transformation: [\n            {\n              crop: \"fit\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.225),\n              height: size - Math.floor(size * 0.225),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_covid.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        }\n      };\n    }\n  },\n  {\n    id: \"twibbon_cs\",\n    category: \"socs\",\n    name: \"Computer Science\",\n    url: \"https://res.cloudinary.com/fep-bot/image/upload/v1564639746/twibbons/twibbon_cs.png\",\n    transform: (filename, size) => {\n      return {\n        auto: {\n          transformation: [\n            {\n              gravity: \"auto\",\n              crop: \"fill\",\n              format: \"jpg\",\n              aspect_ratio: \"1:1\",\n              public_id: `${filename}-twibbon`\n            }, {\n              gravity: \"auto\",\n              crop: \"fill_pad\",\n              width: size,\n              height: size,\n              y: Math.floor(-size * 0.2),\n              x: Math.floor(size * 0.045)\n            }, {\n              overlay: \"twibbons:twibbon_cs.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        },\n        manual: {\n          transformation: [\n            {\n              crop: \"fit\",\n              format: \"jpg\",\n              width: size,\n              height: size,\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_cs.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        }\n      };\n    }\n  },\n  {\n    id: \"twibbon_tfi\",\n    category: \"tfi\",\n    name: \"Teach For Indonesia\",\n    url: \"https://res.cloudinary.com/fep-bot/image/upload/v1565361689/twibbons/twibbon_tfi_old.png\",\n    transform: (filename, size) => {\n      return {\n        auto: {\n          transformation: [\n            {\n              gravity: \"auto\",\n              crop: \"fill\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size + Math.floor(-size * 0.045),\n              height: size + Math.floor(size * 0.2),\n              x: Math.floor(size * 0.045),\n              y: Math.floor(-size * 0.2),\n              public_id: `${filename}-twibbon`\n            }, {\n              gravity: \"auto\",\n              crop: \"fill\",\n              width: size,\n              height: size\n            }, {\n              overlay: \"twibbons:twibbon_tfi.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        },\n        manual: {\n          transformation: [\n            {\n              crop: \"fit\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size,\n              height: size,\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_tfi.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        }\n      };\n    }\n  },\n  {\n    id: \"twibbon_binus1\",\n    category: \"binus\",\n    name: \"Binus 1\",\n    url: \"https://res.cloudinary.com/fep-bot/image/upload/v1565372081/twibbons/twibbon_binus1.png\",\n    transform: (filename, size) => {\n      return {\n        auto: {\n          transformation: [\n            {\n              gravity: \"auto\",\n              crop: \"fill\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.2),\n              height: size - Math.floor(size * 0.2),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_binus1.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        },\n        manual: {\n          transformation: [\n            {\n              crop: \"fit\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.2125),\n              height: size - Math.floor(size * 0.2),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_binus1.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        }\n      };\n    }\n  },\n  {\n    id: \"twibbon_binus2\",\n    category: \"binus\",\n    name: \"Binus 2\",\n    url: \"https://res.cloudinary.com/fep-bot/image/upload/v1585598545/twibbons/twibbon_binus2.png\",\n    transform: (filename, size) => {\n      return {\n        auto: {\n          transformation: [\n            {\n              gravity: \"auto\",\n              crop: \"fill\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.225),\n              height: size - Math.floor(size * 0.225),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_binus2.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        },\n        manual: {\n          transformation: [\n            {\n              crop: \"fit\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.225),\n              height: size - Math.floor(size * 0.225),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_binus2.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        }\n      };\n    }\n  }, {\n    id: \"twibbon_binus3\",\n    category: \"binus\",\n    name: \"Binus 3\",\n    url: \"https://res.cloudinary.com/fep-bot/image/upload/v1585598544/twibbons/twibbon_binus3.png\",\n    transform: (filename, size) => {\n      return {\n        auto: {\n          transformation: [\n            {\n              gravity: \"auto\",\n              crop: \"fill\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.225),\n              height: size - Math.floor(size * 0.225),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_binus3.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        },\n        manual: {\n          transformation: [\n            {\n              crop: \"fit\",\n              format: \"jpg\",\n              // aspect_ratio: \"1:1\",\n              width: size - Math.floor(size * 0.225),\n              height: size - Math.floor(size * 0.225),\n              public_id: `${filename}-twibbon`\n            }, {\n              overlay: \"twibbons:twibbon_binus3.png\",\n              flags: \"relative\",\n              width: size,\n              height: size,\n              aspect_ratio: \"1:1\"\n            }\n          ]\n        }\n      };\n    }\n  },\n  ];\n\n  const ready = args => {\n    if (args.length <= 1) {\n      const data = {\n        category: args[0]\n      };\n\n      // ready-up switch\n      SharedProps.set({\n        [userId]: {\n          twibbon: {\n            id: null,\n            type: null,\n            status: true,\n            source: {\n              id: originId\n            }\n          }\n        }\n      });\n\n      displayList(data.category);\n    } else {\n      Bot.replyText(`${command_prefix}twibbon <type>`);\n    }\n  };\n\n  const displayList = category => {\n    let selected = twibbon_list.filter(twibbon => typeof twibbon.category === \"string\");\n\n    if (category) {\n      selected = selected.filter(twibbon => twibbon.category == category);\n      if (selected.length === 0) {\n        return Bot.replyText(`Tidak ada kategori, lihat di ${command_prefix}twibbon`);\n      }\n    }\n\n    const twibbonColumns = selected.map(twibbon => {\n      return {\n        thumbnailImageUrl: twibbon.url,\n        imageBackgroundColor: \"#FFFFFF\",\n        text: twibbon.name,\n        actions: [\n          {\n            type: \"postback\",\n            label: \"Auto-AI Mode\",\n            data: JSON.stringify({\n              twibbon: {\n                id: twibbon.id,\n                type: \"auto\"\n              }\n            })\n          }, {\n            type: \"postback\",\n            label: \"Manual Mode\",\n            data: JSON.stringify({\n              twibbon: {\n                id: twibbon.id,\n                type: \"manual\"\n              }\n            })\n          }\n        ]\n      };\n    });\n\n    Bot.sendMessage({\n      type: \"template\",\n      altText: \"Twibbon list\",\n      template: {\n        type: \"carousel\",\n        columns: twibbonColumns,\n        imageAspectRatio: \"square\",\n        imageSize: \"cover\"\n      }\n    });\n  };\n\n  const listenPostback = data => {\n    if (data.twibbon) {\n      const { twibbon } = data;\n\n      // ready-up switch\n      SharedProps.set({\n        [userId]: {\n          twibbon: {\n            id: twibbon.id,\n            type: twibbon.type,\n            status: true,\n            source: {\n              id: originId\n            }\n          }\n        }\n      });\n\n      Bot.getProfile().then(profile => {\n        const messages = [`Hai ${profile.displayName}, masukan gambar mu disini~`];\n        if (twibbon.type === \"manual\") {\n          messages.push(`Pastikan 1:1 ya fotonya~\\n\\nTips: gunakan in-app camera line disamping kolom chat dan set ratio ke 1:1`);\n        }\n        Bot.replyText(messages);\n      });\n    }\n  };\n\n  const getTransformedFileUrl = (twibbonSetting, publicId, filename, size) => {\n    const getTwibbonById = twibbon_list.filter(twibbon => twibbon.id === twibbonSetting.id)[0];\n    const result = cloudinary.url(publicId, getTwibbonById.transform(filename, size)[twibbonSetting.type]);\n    return result;\n  };\n\n  const generate = data => {\n    return new Promise((resolve, reject) => {\n      CloudinaryUtils.upload(data.url, data.filename).then(twibbonBackgroundMeta => {\n        performTransformations(twibbonBackgroundMeta);\n      });\n\n      const performTransformations = twibbonBackgroundMeta => {\n        const twibbonOriginalName = `${data.filename}-twibbon`;\n        const resultOriginalUrl = getTransformedFileUrl(data.twibbonSetting, twibbonBackgroundMeta.public_id, twibbonOriginalName, 1040);\n\n        const twibonPreviewName = `${data.filename}-twibbon-preview`;\n        const resultPreviewUrl = getTransformedFileUrl(data.twibbonSetting, twibbonBackgroundMeta.public_id, twibonPreviewName, 240);\n\n        Promise.all([\n          CloudinaryUtils.upload(resultOriginalUrl, twibbonOriginalName),\n          CloudinaryUtils.upload(resultPreviewUrl, twibonPreviewName)\n        ]).then(fileMeta => {\n          resolve({ twibbonOriginalUrl: fileMeta[0].secure_url, twibbonPreviewUrl: fileMeta[1].secure_url });\n\n          fs.unlinkSync(data.originalContentPath);\n          fs.unlinkSync(data.previewPath);\n        });\n      };\n    });\n  };\n\n  const make = args => {\n    const data = {\n      url: args[0],\n      originalContentPath: args[1],\n      previewPath: args[2],\n      twibbonSetting: args[3],\n      filename: Bot.props.event.message.id\n    };\n\n    generate(data).then(({ twibbonOriginalUrl, twibbonPreviewUrl }) => {\n      Bot.sendMessage({ type: \"image\", originalContentUrl: twibbonOriginalUrl, previewImageUrl: twibbonPreviewUrl });\n    });\n\n    //switch back\n    SharedProps.set({\n      [userId]: {\n        twibbon: {\n          id: null,\n          type: null,\n          status: false,\n          source: {\n            id: originId\n          }\n        }\n      }\n    });\n  };\n\n  const listenImage = getContent => {\n    if (SharedProps.store[userId].twibbon) {\n      const userSwitch = SharedProps.store[userId].twibbon.status;\n      const userInSameCommunal = SharedProps.store[userId].twibbon.source.id === originId;\n      const twibbonIdChosen = SharedProps.store[userId].twibbon.id !== undefined;\n\n      if (userSwitch && userInSameCommunal && twibbonIdChosen) {\n        const twibbonSetting = {\n          id: SharedProps.store[userId].twibbon.id,\n          type: SharedProps.store[userId].twibbon.type\n        };\n\n        getContent().then(({ originalContentPath, previewPath, originalContentUrl, previewImageUrl }) => {\n          make([originalContentUrl, originalContentPath, previewPath, twibbonSetting]);\n        });\n      }\n    }\n  };\n\n  return { ready, listenImage, listenPostback };\n};\n"]}