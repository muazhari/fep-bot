{"version":3,"sources":["../../../src/Bot/Features/Twibbon.js"],"names":["download","uri","path","Promise","resolve","reject","request","head","err","res","body","console","log","headers","pipe","fs","createWriteStream","on","Twibbon","Bot","uploads","twibbon_uploads","ready","shared_props","getId","user","replyText","getResult","public_id","filename","size","result","cloudinary","url","transformation","gravity","crop","format","aspect_ratio","width","height","y","Math","floor","x","overlay","flags","imgUpload","uploader","upload","then","image","catch","warn","waitForAllUploads","id","queue","callback","ids","Object","keys","length","join","waitForAllUploadsTwibbon","make","args","data","performTransformations","twibbon_ori_name","result_url","twibbon_bg","twibbon_preview_name","result_preview_url","performResolve","twibbonOriginalUrl","original","secure_url","twibbonPreviewUrl","preview","unlinkSync","pathOri","pathPrev","command_prefix"],"mappings":"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","file":"Twibbon.js","sourcesContent":["import { command_prefix, batch_list, baseURL, shared_props } from \"../../Bot\";\nimport FEPStoreCRUD from \"../../Bot/Helper/FEPStoreCRUD\";\nimport cloudinary from \"cloudinary\";\nimport fs from \"fs\";\nimport request from \"request\";\nimport cp from \"child_process\";\nimport path from \"path\";\n\nconst download = (uri, path) => {\n  return new Promise((resolve, reject) => {\n    request.head(uri, (err, res, body) => {\n      console.log(\"content-type:\", res.headers[\"content-type\"]);\n      console.log(\"content-length:\", res.headers[\"content-length\"]);\n\n      request(uri)\n        .pipe(fs.createWriteStream(path))\n        .on(\"close\", resolve(path))\n        .on(\"error\", reject);\n    });\n  });\n};\n\nexport const Twibbon = Bot => {\n  const uploads = {};\n  const twibbon_uploads = {};\n\n  const ready = () => {\n    // ready-up switch\n    shared_props[Bot.getId().user][\"twibbon\"] = true;\n    Bot.replyText(\"Masukan gambar mu langsung disini~\");\n  };\n\n  const getResult = (public_id, filename, size) => {\n    const result = cloudinary.url(public_id, {\n      transformation: [\n        {\n          gravity: \"auto\",\n          crop: \"fill\",\n          format: \"jpg\",\n          aspect_ratio: \"1:1\",\n          public_id: `${filename}-twibbon`\n        },\n        {\n          gravity: \"auto\",\n          crop: \"fill_pad\",\n          width: size,\n          height: size,\n          y: Math.floor(-size * 0.2),\n          x: Math.floor(size * 0.045)\n        },\n        {\n          overlay: \"twibbon_cs.png\",\n          flags: \"relative\",\n          width: size,\n          height: size,\n          aspect_ratio: \"1:1\"\n        }\n      ]\n    });\n\n    return result;\n  };\n\n  const imgUpload = (url, filename) => {\n    return new Promise((resolve, reject) => {\n      cloudinary.uploader\n        .upload(url, { public_id: filename })\n        .then(image => {\n          console.log(\"** File Upload (Promise)\");\n          console.log(\"* \" + image.public_id);\n          console.log(\"* \" + image.url);\n          resolve(image);\n        })\n        .catch(err => {\n          console.log(\"** File Upload (Promise)\");\n          if (err) {\n            console.warn(err);\n            reject(err);\n          }\n        });\n    });\n  };\n\n  const waitForAllUploads = (id, image, queue, callback) => {\n    uploads[id] = image;\n    const ids = Object.keys(uploads);\n    if (ids.length === queue) {\n      console.log(\n        \"**  uploaded all files (\" + ids.join(\",\") + \") to cloudinary\"\n      );\n      callback();\n    }\n  };\n\n  const waitForAllUploadsTwibbon = (id, image, queue, callback) => {\n    twibbon_uploads[id] = image;\n    const ids = Object.keys(twibbon_uploads);\n    if (ids.length === queue) {\n      console.log(\n        \"**  uploaded all twibbon files (\" + ids.join(\",\") + \") to cloudinary\"\n      );\n      callback();\n    }\n  };\n\n  const make = args => {\n    if (args.length === 3) {\n      const data = {\n        url: args[0],\n        path: args[1],\n        filename: args[2]\n      };\n\n      console.log(data);\n\n      return new Promise(async (resolve, reject) => {\n        imgUpload(data.url, data.filename).then(image => {\n          waitForAllUploads(\"twibbon_bg\", image, 1, performTransformations);\n        });\n\n        const twibbon_ori_name = `${data.filename}-twibbon`;\n        const performTransformations = () => {\n          const result_url = getResult(\n            uploads.twibbon_bg.public_id,\n            twibbon_ori_name,\n            1040\n          );\n\n          const twibbon_preview_name = `${data.filename}-twibbon-preview`;\n          const result_preview_url = getResult(\n            uploads.twibbon_bg.public_id,\n            twibbon_preview_name,\n            240\n          );\n\n          imgUpload(result_url, twibbon_ori_name).then(image => {\n            waitForAllUploadsTwibbon(\"original\", image, 2, performResolve);\n          });\n\n          imgUpload(result_preview_url, twibbon_preview_name).then(image => {\n            waitForAllUploadsTwibbon(\"preview\", image, 2, performResolve);\n          });\n\n          const performResolve = () => {\n            resolve({\n              twibbonOriginalUrl: `${twibbon_uploads.original.secure_url}`,\n              twibbonPreviewUrl: `${twibbon_uploads.preview.secure_url}`\n            });\n\n            fs.unlinkSync(data.path.pathOri);\n            fs.unlinkSync(data.path.pathPrev);\n          };\n        };\n      });\n    } else {\n      Bot.replyText(`${command_prefix}twibbon <image>`);\n    }\n  };\n\n  return {\n    make,\n    ready\n  };\n};\n"]}