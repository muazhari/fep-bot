{"version":3,"sources":["../../src/Bot/Bot.js"],"names":["line","shared_props","Bot","constructor","props","getId","bind","initProps","client","Client","config","Features","FEPList","StoreAdvance","Basic","Access","Template","Twibbon","DialogFlow","event","source","default","user","log","log_chat","Store","getStore","Object","keys","length","groups","users","setProps","data","id","console","map","key","Id","groupId","roomId","userId","replyText","texts","Array","isArray","replyMessage","replyToken","text","type","sendMessage","message","msg","downloadContent","messageId","downloadPath","getMessageContent","then","stream","Promise","resolve","reject","writeable","fs","createWriteStream","pipe","on"],"mappings":";;;;;;;;;AAQA;;AARA;;;;AACA;;IAAYA,I;;AACZ;;AACA;;AACA;;;;AACA;;;;AACA;;;;AAIA;;;;;;;;AAEA;AACO,MAAMC,sCAAe,EAArB;;AAEA,MAAMC,GAAN,CAAU;AACfC,cAAYC,KAAZ,EAAmB;AACjB,SAAKC,KAAL,GAAa,KAAKA,KAAL,CAAWC,IAAX,CAAgB,IAAhB,CAAb;AACA,SAAKC,SAAL,GAAiB,KAAKA,SAAL,CAAeD,IAAf,CAAoB,IAApB,CAAjB;;AAEA;AACA;AACA;AACA,SAAKF,KAAL,GAAa,KAAKG,SAAL,CAAeH,KAAf,CAAb;AACA;;AAEA;AACA,SAAKI,MAAL,GAAc,IAAIR,KAAKS,MAAT,CAAgBC,cAAhB,CAAd;;AAEA;AACA,SAAKC,QAAL,GAAgB;AACdC,eAAS,uBAAQ,IAAR,CADK;AAEdC,oBAAc,4BAAa,IAAb,CAFA;AAGdC,aAAO,qBAAM,IAAN,CAHO;AAIdC,cAAQ,sBAAO,IAAP,CAJM;AAKdC,gBAAU,wBAAS,IAAT,CALI;AAMdC,eAAS,uBAAQ,IAAR;AANK,KAAhB;;AASA;AACA,SAAKC,UAAL,GAAkB,IAAIA,sBAAJ,CAAe,IAAf,CAAlB;AACD;;AAEDX,YAAUH,KAAV,EAAiB;AACfH,iBAAa,KAAKI,KAAL,CAAWD,MAAMe,KAAN,CAAYC,MAAvB,EAA+BC,OAA5C,iBACKpB,aAAa,KAAKI,KAAL,CAAWD,MAAMe,KAAN,CAAYC,MAAvB,EAA+BC,OAA5C,CADL;AAEEF,aAAOf,MAAMe;AAFf;;AAKAlB,iBAAa,KAAKI,KAAL,CAAWD,MAAMe,KAAN,CAAYC,MAAvB,EAA+BE,IAA5C,iBACKrB,aAAa,KAAKI,KAAL,CAAWD,MAAMe,KAAN,CAAYC,MAAvB,EAA+BE,IAA5C,CADL;AAEEH,aAAOf,MAAMe;AAFf;;AAKA,WAAOlB,aAAa,KAAKI,KAAL,CAAWD,MAAMe,KAAN,CAAYC,MAAvB,EAA+BC,OAA5C,CAAP;AACD;;AAED,QAAME,GAAN,GAAY;AACV,QAAIC,WAAW,MAAMC,gBAAMC,QAAN,CAAe,UAAf,CAArB;AACA,QAAI,CAACF,QAAD,IAAaG,OAAOC,IAAP,CAAYJ,QAAZ,EAAsBK,MAAtB,KAAiC,CAAlD,EAAqD;AACnDL,iBAAW;AACTM,gBAAQ,EADC;AAETC,eAAO;AAFE,OAAX;AAID;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;;AAEDC,WAASC,IAAT,EAAeC,EAAf,EAAmB;AACjBC,YAAQZ,GAAR,CAAYU,IAAZ;AACA,QAAI,CAACC,EAAL,EAASA,KAAK,KAAK7B,KAAL,GAAagB,OAAlB;;AAETM,WAAOC,IAAP,CAAYK,IAAZ,EAAkBG,GAAlB,CAAsBC,OAAO;AAC3B,WAAKpC,YAAL,CAAkBiC,EAAlB,EAAsBG,GAAtB,IAA6BJ,KAAKI,GAAL,CAA7B;AACD,KAFD;AAGD;;AAEDhC,QAAMe,MAAN,EAAc;AACZ,QAAI,CAACA,MAAL,EAAaA,SAAS,KAAKhB,KAAL,CAAWe,KAAX,CAAiBC,MAA1B;AACb,UAAMkB,KAAK,EAAX;;AAEA,QAAIlB,OAAOmB,OAAX,EAAoB;AAClBD,SAAG,SAAH,IAAgBlB,OAAOmB,OAAvB;AACD,KAFD,MAEO;AACL,UAAInB,OAAOoB,MAAX,EAAmB;AACjBF,WAAG,SAAH,IAAgBlB,OAAOoB,MAAvB;AACD,OAFD,MAEO;AACL,YAAIpB,OAAOqB,MAAX,EAAmB;AACjBH,aAAG,SAAH,IAAgBlB,OAAOqB,MAAvB;AACD;AACF;AACF;;AAED,QAAIrB,OAAOmB,OAAX,EAAoB;AAClBD,SAAG,OAAH,IAAclB,OAAOmB,OAArB;AACD;AACD,QAAInB,OAAOoB,MAAX,EAAmB;AACfF,SAAG,MAAH,IAAalB,OAAOoB,MAApB;AACH;AACD,QAAIpB,OAAOqB,MAAX,EAAmB;AACfH,SAAG,MAAH,IAAalB,OAAOqB,MAApB;AACH;;AAED,QAAIH,EAAJ,EAAQ,OAAOA,EAAP;AACT;;AAEDI,YAAUC,KAAV,EAAiB;AACfA,YAAQC,MAAMC,OAAN,CAAcF,KAAd,IAAuBA,KAAvB,GAA+B,CAACA,KAAD,CAAvC;AACA,WAAO,KAAKnC,MAAL,CAAYsC,YAAZ,CACL,KAAK1C,KAAL,CAAWe,KAAX,CAAiB4B,UADZ,EAELJ,MAAMP,GAAN,CAAUY,SAAS,EAAEC,MAAM,MAAR,EAAgBD,IAAhB,EAAT,CAAV,CAFK,CAAP;AAID;;AAEDE,cAAYC,OAAZ,EAAqB;AACnBA,cAAUP,MAAMC,OAAN,CAAcM,OAAd,IAAyBA,OAAzB,GAAmC,CAACA,OAAD,CAA7C;AACA,WAAO,KAAK3C,MAAL,CAAYsC,YAAZ,CACL,KAAK1C,KAAL,CAAWe,KAAX,CAAiB4B,UADZ,EAELI,QAAQf,GAAR,CAAYgB,OAAOA,GAAnB,CAFK,CAAP;AAID;;AAEDC,kBAAgBC,SAAhB,EAA2BC,YAA3B,EAAyC;AACvC,WAAO,KAAK/C,MAAL,CAAYgD,iBAAZ,CAA8BF,SAA9B,EAAyCG,IAAzC,CACLC,UACE,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC/B,YAAMC,YAAYC,kBAAGC,iBAAH,CAAqBT,YAArB,CAAlB;AACAG,aAAOO,IAAP,CAAYH,SAAZ;AACAJ,aAAOQ,EAAP,CAAU,KAAV,EAAiB,MAAMN,QAAQL,YAAR,CAAvB;AACAG,aAAOQ,EAAP,CAAU,OAAV,EAAmBL,MAAnB;AACD,KALD,CAFG,CAAP;AASD;AArIc;QAAJ3D,G,GAAAA,G","file":"Bot.js","sourcesContent":["import Store from \"../Services/Store\";\nimport * as line from \"@line/bot-sdk\";\nimport { FEPList, StoreAdvance, Basic, Access, Template, Twibbon } from \"./Features\";\nimport { DialogFlow } from \"./DialogFlow\";\nimport fs from \"fs-extra\";\nimport mkdirp from \"mkdirp\";\nimport path from \"path\";\n\n// import { default_agent } from \"../Config/DialogFlow\";\n\nimport config from \"../Config/Line\";\n\n// share worker props by groupId\nexport const shared_props = {};\n\nexport class Bot {\n  constructor(props) {\n    this.getId = this.getId.bind(this);\n    this.initProps = this.initProps.bind(this)\n    \n    // this.shared_props = shared_props\n    // console.log(shared_props)\n    // only access by? user, group, room, default\n    this.props = this.initProps(props)\n    // console.log(this.props)\n\n    // create LINE SDK client\n    this.client = new line.Client(config);\n\n    // Features creator\n    this.Features = {\n      FEPList: FEPList(this),\n      StoreAdvance: StoreAdvance(this),\n      Basic: Basic(this),\n      Access: Access(this),\n      Template: Template(this),\n      Twibbon: Twibbon(this)\n    };\n\n    // DialogFlow assist\n    this.DialogFlow = new DialogFlow(this);\n  }\n  \n  initProps(props) {\n    shared_props[this.getId(props.event.source).default] = {\n      ...shared_props[this.getId(props.event.source).default],\n      event: props.event\n    };\n    \n    shared_props[this.getId(props.event.source).user] = {\n      ...shared_props[this.getId(props.event.source).user],\n      event: props.event\n    };\n    \n    return shared_props[this.getId(props.event.source).default]\n  }\n\n  async log() {\n    let log_chat = await Store.getStore(\"log_chat\");\n    if (!log_chat || Object.keys(log_chat).length === 0) {\n      log_chat = {\n        groups: {},\n        users: {}\n      };\n    }\n\n    // switch (this.props.event.source.type) {\n    // case 'user':\n    //     const { userId } = this.props.event.source\n    //     if (!log_chat['users'][userId]) {\n    //       log_chat['users'][userId] = []\n    //     }\n    //     log_chat['user'][userId].push(this.props.event)\n    //     return await Store.setStore({ log_chat: log_chat })\n    // case 'group':\n    //     const { groupId } = this.props.event.source\n    //     if (!log_chat['groups'][groupId]) {\n    //       log_chat['groups'][groupId] = []\n    //     }\n    //     log_chat['groups'][groupId].push(this.props.event)\n    //     return await Store.setStore({ log_chat: log_chat })\n    // }\n  }\n\n  setProps(data, id) {\n    console.log(data);\n    if (!id) id = this.getId().default;\n\n    Object.keys(data).map(key => {\n      this.shared_props[id][key] = data[key];\n    });\n  }\n\n  getId(source) {\n    if (!source) source = this.props.event.source;\n    const Id = {};\n\n    if (source.groupId) {\n      Id[\"default\"] = source.groupId;\n    } else {\n      if (source.roomId) {\n        Id[\"default\"] = source.roomId;\n      } else {\n        if (source.userId) {\n          Id[\"default\"] = source.userId;\n        }\n      }\n    }\n    \n    if (source.groupId) {\n      Id[\"group\"] = source.groupId;\n    }\n    if (source.roomId) {\n        Id[\"room\"] = source.roomId;\n    }\n    if (source.userId) {\n        Id[\"user\"] = source.userId;\n    }\n\n    if (Id) return Id;\n  }\n\n  replyText(texts) {\n    texts = Array.isArray(texts) ? texts : [texts];\n    return this.client.replyMessage(\n      this.props.event.replyToken,\n      texts.map(text => ({ type: \"text\", text }))\n    );\n  }\n\n  sendMessage(message) {\n    message = Array.isArray(message) ? message : [message];\n    return this.client.replyMessage(\n      this.props.event.replyToken,\n      message.map(msg => msg)\n    );\n  }\n\n  downloadContent(messageId, downloadPath) {\n    return this.client.getMessageContent(messageId).then(\n      stream =>\n        new Promise((resolve, reject) => {\n          const writeable = fs.createWriteStream(downloadPath);\n          stream.pipe(writeable);\n          stream.on(\"end\", () => resolve(downloadPath));\n          stream.on(\"error\", reject);\n        })\n    );\n  }\n}\n"]}