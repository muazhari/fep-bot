{"version":3,"sources":["../../src/Bot/Bot.js"],"names":["line","shared_props","Bot","constructor","props","getId","bind","initProps","client","Client","config","Features","FEPList","StoreAdvance","Basic","Access","Template","Twibbon","Courses","PosetLattice","DialogFlow","sourceIds","event","source","Object","keys","map","type","origin","profile","Promise","resolve","reject","getProfile","user","then","catch","log","Store","getStore","log_chat","length","groups","users","setProps","data","id","console","key","groupId","roomId","userId","replyText","texts","Array","isArray","replyMessage","replyToken","text","sendMessage","message","msg","downloadContent","messageId","downloadPath","getMessageContent","stream","writeable","fs","createWriteStream","pipe","on"],"mappings":"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","file":"Bot.js","sourcesContent":["import Store from \"../Services/Store\";\nimport * as line from \"@line/bot-sdk\";\nimport {\n  FEPList,\n  StoreAdvance,\n  Basic,\n  Access,\n  Template,\n  Twibbon,\n  Courses,\n  PosetLattice\n} from \"./Features\";\nimport { DialogFlow } from \"./DialogFlow\";\nimport fs from \"fs-extra\";\nimport mkdirp from \"mkdirp\";\nimport path from \"path\";\nimport uuid from \"uuid\";\n\nimport config from \"../Config/Line\";\n\n// share worker props by groupId\nexport const shared_props = {};\n// export const listener_stack = {\n//   postback: {}\n// };\n\n// class listener {\n//   constructor(Bot){\n//     this.Bot = Bot\n//     this.event = this.Bot.props.event\n//   }\n\n//   push(callback){\n//     listener_stack[this.Bot.getId().user] = callback\n//   }\n\n//   postback(stringObject, callback) {\n//     const data = JSON.parse(stringObject)\n//     return callback(listener_stack.postback[uuid.v4])\n//   }\n// }\n\nexport class Bot {\n  constructor(props) {\n    this.getId = this.getId.bind(this);\n    this.initProps = this.initProps.bind(this);\n\n    // this.shared_props = shared_props\n    // console.log(shared_props)\n    // only access by? user, group, room, origin\n    this.props = this.initProps(props);\n    // console.log(this.props)\n\n    // create LINE SDK client\n    this.client = new line.Client(config);\n\n    // Features creator\n    this.Features = {\n      FEPList: FEPList(this),\n      StoreAdvance: StoreAdvance(this),\n      Basic: Basic(this),\n      Access: Access(this),\n      Template: Template(this),\n      Twibbon: Twibbon(this),\n      Courses: Courses(this),\n      PosetLattice: PosetLattice(this)\n    };\n\n    // DialogFlow assist\n    this.DialogFlow = new DialogFlow(this);\n\n    // Events listen assist\n    // this.listener = new listener(this)\n  }\n\n  initProps(props) {\n    const sourceIds = this.getId(props.event.source);\n\n    Object.keys(sourceIds).map(type => {\n      shared_props[sourceIds[type]] = {\n        ...shared_props[sourceIds[type]],\n        event: props.event\n      };\n    });\n\n    return shared_props[sourceIds.origin];\n  }\n\n  profile() {\n    return new Promise((resolve, reject) => {\n      this.client\n        .getProfile(this.getId().user)\n        .then(resolve)\n        .catch(reject);\n    });\n  }\n\n  log() {\n    Store.getStore(\"log_chat\").then(log_chat => {\n      if (!log_chat || Object.keys(log_chat).length === 0) {\n        log_chat = {\n          groups: {},\n          users: {}\n        };\n      }\n\n      // switch (this.props.event.source.type) {\n      // case 'user':\n      //     const { userId } = this.props.event.source\n      //     if (!log_chat['users'][userId]) {\n      //       log_chat['users'][userId] = []\n      //     }\n      //     log_chat['user'][userId].push(this.props.event)\n      //     return await Store.setStore({ log_chat: log_chat })\n      // case 'group':\n      //     const { groupId } = this.props.event.source\n      //     if (!log_chat['groups'][groupId]) {\n      //       log_chat['groups'][groupId] = []\n      //     }\n      //     log_chat['groups'][groupId].push(this.props.event)\n      //     return await Store.setStore({ log_chat: log_chat })\n      // }\n    });\n  }\n\n  setProps(data, id) {\n    console.log(data);\n    if (!id) id = this.getId().origin;\n\n    Object.keys(data).map(key => {\n      this.shared_props[id][key] = data[key];\n    });\n  }\n\n  getId(source) {\n    if (!source) source = this.props.event.source;\n    const type = {};\n\n    if (source.groupId) {\n      type[\"origin\"] = source.groupId;\n    } else {\n      if (source.roomId) {\n        type[\"origin\"] = source.roomId;\n      } else {\n        if (source.userId) {\n          type[\"origin\"] = source.userId;\n        }\n      }\n    }\n\n    if (source.groupId) {\n      type[\"group\"] = source.groupId;\n    }\n    if (source.roomId) {\n      type[\"room\"] = source.roomId;\n    }\n    if (source.userId) {\n      type[\"user\"] = source.userId;\n    }\n\n    if (type) return type;\n  }\n\n  replyText(texts) {\n    texts = Array.isArray(texts) ? texts : [texts];\n    return this.client.replyMessage(\n      this.props.event.replyToken,\n      texts.map(text => ({ type: \"text\", text }))\n    );\n  }\n\n  sendMessage(message) {\n    message = Array.isArray(message) ? message : [message];\n    return this.client.replyMessage(\n      this.props.event.replyToken,\n      message.map(msg => msg)\n    );\n  }\n\n  downloadContent(messageId, downloadPath) {\n    return this.client.getMessageContent(messageId).then(\n      stream =>\n        new Promise((resolve, reject) => {\n          const writeable = fs.createWriteStream(downloadPath);\n          stream.pipe(writeable);\n          stream.on(\"end\", () => resolve(downloadPath));\n          stream.on(\"error\", reject);\n        })\n    );\n  }\n}\n"]}