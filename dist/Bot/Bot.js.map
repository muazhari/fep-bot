{"version":3,"sources":["../../src/Bot/Bot.js"],"names":["line","Bot","constructor","props","initProps","client","Client","config","console","log","sourceIds","getId","event","source","Object","keys","map","type","SharedProps","store","set","get","origin","getProfile","Promise","resolve","reject","user","then","catch","groupId","roomId","userId","replyText","texts","Array","isArray","replyMessage","replyToken","text","length","sendMessage","message","msg","downloadContent","messageId","downloadPath","getMessageContent","stream","writeable","fs","createWriteStream","pipe","on","err"],"mappings":"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","file":"Bot.js","sourcesContent":["import * as line from \"@line/bot-sdk\";\nimport {\n  FEPList,\n  StoreAdvance,\n  Basic,\n  Access,\n  Template,\n  Twibbon,\n  Courses,\n  PosetLattice\n} from \"./Features\";\nimport {dialogFlow} from \"./DialogFlow\";\nimport Store from \"../Services/Store\";\nimport fs from \"fs-extra\";\nimport mkdirp from \"mkdirp\";\nimport path from \"path\";\nimport uuid from \"uuid\";\n\nimport config from \"../Config/Line\";\n\nimport {handlerBot, SharedProps} from \"../Bot\";\n\nimport Firebase from \"../Services/Firebase\";\n\n// share worker props by groupId\n// export const listener_stack = {\n//   postback: {}\n// };\n\n// class listener {\n//   constructor(Bot){\n//     this.Bot = Bot\n//     this.event = this.Bot.props.event\n//   }\n\n//   push(callback){\n//     listener_stack[this.Bot.getId().user] = callback\n//   }\n\n//   postback(stringObject, callback) {\n//     const data = JSON.parse(stringObject)\n//     return callback(listener_stack.postback[uuid.v4])\n//   }\n// }\n\nexport class Bot {\n  constructor(props) {\n    // console.log(SharedProps.store)\n    // only access by? user, group, room, origin\n    this.props = this.initProps(props);\n    // console.log(this.props)\n\n    // create LINE SDK client\n    this.client = new line.Client(config);\n\n    //  Features creator\n    // this.Features = {\n    //   FEPList: FEPList(this),\n    //   StoreAdvance: StoreAdvance(this),\n    //   Basic: Basic(this),\n    //   Access: Access(this),\n    //   Template: Template(this),\n    //   Twibbon: Twibbon(this),\n    //   Courses: Courses(this),\n    //   PosetLattice: PosetLattice(this)\n    // };\n\n    //  DialogFlow assist\n    // this.dialogFlow = new dialogFlow(this);\n\n    //   Events listen assist\n    // this.handler = new handlerBot(this);\n    // SharedProps.log(this.getId().user);\n    console.log(\"[Bot] Instanced\");\n  }\n\n  //should updated to implement firebase realtime database\n  initProps(props) {\n    const sourceIds = this.getId(props.event.source);\n\n    Object.keys(sourceIds).map(type => {\n      SharedProps.store.set([sourceIds[type]], {\n        ...SharedProps.store.get([sourceIds[type]]),\n        event: props.event\n      });\n    });\n\n    return SharedProps.store.get([sourceIds.origin]);\n  }\n\n  getProfile() {\n    return new Promise((resolve, reject) => {\n      this.client.getProfile(this.getId().user).then(resolve).catch(reject);\n      console.log(\"[Bot] Got profile\");\n    });\n  }\n\n  getId(source) {\n    if (!source) \n      source = this.props.event.source;\n    const type = {};\n\n    if (source.groupId) {\n      type[\"origin\"] = source.groupId;\n    } else {\n      if (source.roomId) {\n        type[\"origin\"] = source.roomId;\n      } else {\n        if (source.userId) {\n          type[\"origin\"] = source.userId;\n        }\n      }\n    }\n\n    if (source.groupId) {\n      type[\"group\"] = source.groupId;\n    }\n    if (source.roomId) {\n      type[\"room\"] = source.roomId;\n    }\n    if (source.userId) {\n      type[\"user\"] = source.userId;\n    }\n\n    if (type) \n      return type;\n    }\n  \n  replyText(texts) {\n    texts = Array.isArray(texts)\n      ? texts\n      : [texts];\n    return this.client.replyMessage(this.props.event.replyToken, texts.map(text => {\n      console.log(\"[Bot] Sent Text, length: \", text.length);\n      return {type: \"text\", text};\n    }));\n  }\n\n  sendMessage(message) {\n    message = Array.isArray(message)\n      ? message\n      : [message];\n    return this.client.replyMessage(this.props.event.replyToken, message.map(msg => {\n      console.log(\"[Bot] Sent Message\");\n      return msg;\n    }));\n  }\n\n  downloadContent(messageId, downloadPath) {\n    return this.client.getMessageContent(messageId).then(stream => new Promise((resolve, reject) => {\n      const writeable = fs.createWriteStream(downloadPath);\n      stream.pipe(writeable);\n      stream.on(\"end\", () => {\n        console.log(\"[Bot] Content Download Success\", downloadPath);\n        resolve(downloadPath);\n      });\n      stream.on(\"error\", err => {\n        console.log(\"[Bot] Content Download Failed \", err);\n        reject(err);\n      });\n    }));\n  }\n}\n"]}