{"version":3,"sources":["../../src/Bot/Bot.js"],"names":["line","Bot","constructor","props","event","client","Client","config","Features","FEPList","StoreAdvance","Basic","Access","Template","Twibbon","Courses","PosetLattice","dialogFlow","handler","handlerBot","log","console","getProfile","Promise","resolve","reject","getId","user","then","catch","Firebase","fdb","collection","add","timestamp","setProps","data","id","origin","Object","keys","map","key","SharedProps","store","source","type","groupId","roomId","userId","replyText","texts","Array","isArray","replyMessage","replyToken","text","sendMessage","message","msg","length","downloadContent","messageId","downloadPath","getMessageContent","stream","writeable","fs","createWriteStream","pipe","on"],"mappings":"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","file":"Bot.js","sourcesContent":["import Store from \"../Services/Store\";\nimport * as line from \"@line/bot-sdk\";\nimport {\n  FEPList,\n  StoreAdvance,\n  Basic,\n  Access,\n  Template,\n  Twibbon,\n  Courses,\n  PosetLattice\n} from \"./Features\";\nimport {dialogFlow} from \"./DialogFlow\";\nimport fs from \"fs-extra\";\nimport mkdirp from \"mkdirp\";\nimport path from \"path\";\nimport uuid from \"uuid\";\n\nimport config from \"../Config/Line\";\n\nimport {handlerBot, SharedProps} from \"../Bot\";\n\nimport Firebase from \"../Services/Firebase\";\n\n// share worker props by groupId\n// export const listener_stack = {\n//   postback: {}\n// };\n\n// class listener {\n//   constructor(Bot){\n//     this.Bot = Bot\n//     this.event = this.Bot.props.event\n//   }\n\n//   push(callback){\n//     listener_stack[this.Bot.getId().user] = callback\n//   }\n\n//   postback(stringObject, callback) {\n//     const data = JSON.parse(stringObject)\n//     return callback(listener_stack.postback[uuid.v4])\n//   }\n// }\n\nexport class Bot {\n  constructor(props) {\n    // console.log(SharedProps.store)\n    // only access by? user, group, room, origin\n    // this.props = this.initProps(props);\n    this.props = {\n      event: props\n    };\n    // console.log(this.props)\n\n    // create LINE SDK client\n    this.client = new line.Client(config);\n\n    // Features creator\n    this.Features = {\n      FEPList: FEPList(this),\n      StoreAdvance: StoreAdvance(this),\n      Basic: Basic(this),\n      Access: Access(this),\n      Template: Template(this),\n      Twibbon: Twibbon(this),\n      Courses: Courses(this),\n      PosetLattice: PosetLattice(this)\n    };\n\n    // DialogFlow assist\n    this.dialogFlow = new dialogFlow(this);\n\n    // Events listen assist\n    this.handler = new handlerBot(this);\n    this.log();\n    console.log(\"Bot instanced\");\n  }\n\n  //should updated to implement firebase realtime database\n  // initProps(props) {\n  //   const sourceIds = this.getId(props.event.source);\n\n  //   Object.keys(sourceIds).map(type => {\n  //     SharedProps.store[sourceIds[type]] = {\n  //       ...SharedProps.store[sourceIds[type]],\n  //       event: props.event\n  //     };\n  //   });\n\n  //   return SharedProps.store[sourceIds.origin];\n  // }\n\n  getProfile() {\n    return new Promise((resolve, reject) => {\n      this.client.getProfile(this.getId().user).then(resolve).catch(reject);\n    });\n  }\n\n  log() {\n    new Promise(async (resolve, reject) => {\n      // const val = {\n      //   [this.props.event.timestamp]: this.props\n      // };\n      // let data = await Store.getStore(\"propsLogs\");\n      // if (data === undefined) {\n      //   data = [val];\n      // } else {\n      //   data.push(val);\n      // }\n      // await Store.setStore(val);\n      Firebase.fdb.collection(\"Props\").add(this.props);\n      console.log(\"[LOG] Props logged\", this.props.event.timestamp);\n    });\n\n    // switch (this.props.event.source.type) {\n    // case 'user':\n    //     const { userId } = this.props.event.source\n    //     if (!log_chat['users'][userId]) {\n    //       log_chat['users'][userId] = []\n    //     }\n    //     log_chat['user'][userId].push(this.props.event)\n    //     return await Store.setStore({ log_chat: log_chat })\n    // case 'group':\n    //     const { groupId } = this.props.event.source\n    //     if (!log_chat['groups'][groupId]) {\n    //       log_chat['groups'][groupId] = []\n    //     }\n    //     log_chat['groups'][groupId].push(this.props.event)\n    //     return await Store.setStore({ log_chat: log_chat })\n    // }\n  }\n\n  setProps(data, id) {\n    console.log(data);\n    if (!id) \n      id = this.getId().origin;\n    \n    Object.keys(data).map(key => {\n      SharedProps.store[id][key] = data[key];\n    });\n  }\n\n  getId(source) {\n    if (!source) \n      source = this.props.event.source;\n    const type = {};\n\n    if (source.groupId) {\n      type[\"origin\"] = source.groupId;\n    } else {\n      if (source.roomId) {\n        type[\"origin\"] = source.roomId;\n      } else {\n        if (source.userId) {\n          type[\"origin\"] = source.userId;\n        }\n      }\n    }\n\n    if (source.groupId) {\n      type[\"group\"] = source.groupId;\n    }\n    if (source.roomId) {\n      type[\"room\"] = source.roomId;\n    }\n    if (source.userId) {\n      type[\"user\"] = source.userId;\n    }\n\n    if (type) \n      return type;\n    }\n  \n  replyText(texts) {\n    texts = Array.isArray(texts)\n      ? texts\n      : [texts];\n    return this.client.replyMessage(this.props.event.replyToken, texts.map(text => ({type: \"text\", text})));\n  }\n\n  sendMessage(message) {\n    message = Array.isArray(message)\n      ? message\n      : [message];\n    return this.client.replyMessage(this.props.event.replyToken, message.map(msg => {\n      console.log(\"Message length\", msg.length);\n      return msg;\n    }));\n  }\n\n  downloadContent(messageId, downloadPath) {\n    return this.client.getMessageContent(messageId).then(stream => new Promise((resolve, reject) => {\n      const writeable = fs.createWriteStream(downloadPath);\n      stream.pipe(writeable);\n      stream.on(\"end\", () => resolve(downloadPath));\n      stream.on(\"error\", reject);\n    }));\n  }\n}\n"]}