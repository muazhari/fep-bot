{"version":3,"sources":["../../../src/Bot/DialogFlow/DialogFlow.js"],"names":["DialogFlow","constructor","Bot","propsId","getId","origin","initDialogFlowProps","agent","default_agent","projectId","config","sessionId","uuid","v4","sessionClient","dialogflow","SessionsClient","sessionPath","shared_props","undefined","isTalking","getParameter","responses","fields","queryResult","parameters","displayName","intent","allRequiredParamsPresent","getQuery","msg","query","session","queryInput","text","languageCode","chatGate","parameter","chatCallback","dialogFlow","Object","keys","includes","JSON","parse","chat","stringValue","Promise","resolve","reject","message","props","event","detectIntent","then","fulfillmentText","console","log","stringify","err"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AAEO,MAAMA,UAAN,CAAiB;AACtBC,cAAYC,GAAZ,EAAiB;AACf,SAAKA,GAAL,GAAWA,GAAX;AACA,SAAKC,OAAL,GAAe,KAAKD,GAAL,CAASE,KAAT,GAAiBC,MAAhC;AACA,SAAKC,mBAAL;;AAEA;AACA,SAAKC,KAAL,GAAaC,yBAAb;AACA,SAAKC,SAAL,GAAiB,KAAKF,KAAL,CAAWE,SAA5B;AACA,SAAKC,MAAL,GAAc,KAAKH,KAAL,CAAWG,MAAzB;;AAEA;AACA,SAAKC,SAAL,GAAiBC,eAAKC,EAAL,EAAjB;;AAEA;AACA,SAAKC,aAAL,GAAqB,IAAIC,qBAAWC,cAAf,CAA8B,KAAKN,MAAnC,CAArB;AACA,SAAKO,WAAL,GAAmB,KAAKH,aAAL,CAAmBG,WAAnB,CACjB,KAAKR,SADY,EAEjB,KAAKE,SAFY,CAAnB;AAKD;;AAEDL,wBAAqB;AACnB,QAAIY,kBAAa,KAAKf,OAAlB,EAA2B,YAA3B,MAA6CgB,SAAjD,EAA4D;AAC1DD,wBAAa,KAAKf,OAAlB,EAA2B,YAA3B,IAA2C,EAAEiB,WAAW,KAAb,EAA3C;AACD;AACF;;AAEDC,eAAaC,SAAb,EAAwB;AACtB,UAAM,EAAEC,MAAF,KAAaD,UAAU,CAAV,EAAaE,WAAb,CAAyBC,UAA5C;AACA,UAAM,EAAEC,WAAF,KAAkBJ,UAAU,CAAV,EAAaE,WAAb,CAAyBG,MAAjD;AACA,UAAM,EAAEC,wBAAF,KAA+BN,UAAU,CAAV,EAAaE,WAAlD;AACA,WAAO,EAAEE,WAAF,EAAeH,MAAf,EAAuBK,wBAAvB,EAAP;AACD;;AAEDC,WAASC,GAAT,EAAc;AACZ,UAAMC,QAAQ;AACZC,eAAS,KAAKf,WADF;AAEZgB,kBAAY;AACVC,cAAM;AACJ;AACAA,gBAAMJ,GAFF;AAGJ;AACAK,wBAAc;AAJV;AADI;AAFA,KAAd;AAWA,WAAOJ,KAAP;AACD;;AAEDK,WAASC,SAAT,EAAoBC,YAApB,EAAkC;AAChC,UAAM,EAAEf,MAAF,EAAUG,WAAV,KAA0BW,SAAhC;AACA,QACEnB,kBAAa,KAAKf,OAAlB,EAA2BoC,UAA3B,CAAsCnB,SAAtC,IACAM,gBAAgB,WAFlB,EAGE;AACA,UAAIc,OAAOC,IAAP,CAAYlB,MAAZ,EAAoBmB,QAApB,CAA6B,MAA7B,CAAJ,EAA0C;AACxCxB,0BAAa,KAAKf,OAAlB,EAA2BoC,UAA3B,CAAsCnB,SAAtC,GAAkDuB,KAAKC,KAAL,CAChDrB,OAAOsB,IAAP,CAAYC,WADoC,CAAlD;AAGD;AACD,aAAOR,cAAP;AACD;AACF;;AAED;AACAO,SAAO;AACL,WAAO,IAAIE,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,UAAI;AACF,cAAM,EAAEC,OAAF,KAAc,KAAKhD,GAAL,CAASiD,KAAT,CAAeC,KAAnC;AACA,cAAMrB,QAAQ,KAAKF,QAAL,CAAcqB,QAAQhB,IAAtB,CAAd;AACA,aAAKpB,aAAL,CAAmBuC,YAAnB,CAAgCtB,KAAhC,EAAuCuB,IAAvC,CAA4ChC,aAAa;AACvD,gBAAMe,YAAY,KAAKhB,YAAL,CAAkBC,SAAlB,CAAlB;;AAEA,gBAAM,EAAEE,WAAF,KAAkBF,UAAU,CAAV,CAAxB;AACA,gBAAM,EAAEiC,eAAF,KAAsB/B,WAA5B;;AAEA,gBAAMc,eAAe,MAAM;AACzB,mBAAOU,QAAQ,EAAEO,eAAF,EAAmBlB,SAAnB,EAAR,CAAP;AACD,WAFD;;AAIA;AACA,eAAKD,QAAL,CAAcC,SAAd,EAAyBC,YAAzB;AACA;;AAEAkB,kBAAQC,GAAR,CACE,WADF,EAEEvC,kBAAa,KAAKf,OAAlB,EAA2BoC,UAA3B,CAAsCnB,SAFxC;AAIAoC,kBAAQC,GAAR,CAAY,WAAZ,EAAyBd,KAAKe,SAAL,CAAerB,SAAf,CAAzB;AACAmB,kBAAQC,GAAR,CAAY,iBAAZ,EAA+BnC,UAAU,CAAV,EAAaE,WAAb,CAAyBE,WAAxD;AACA8B,kBAAQC,GAAR,CAAYd,KAAKe,SAAL,CAAepC,SAAf,CAAZ;AACD,SArBD;AAsBD,OAzBD,CAyBE,OAAOqC,GAAP,EAAY;AACZV,eAAOU,GAAP;AACD;AACF,KA7BM,CAAP;AA8BD;AAlGqB;QAAX3D,U,GAAAA,U","file":"DialogFlow.js","sourcesContent":["import dialogflow from \"dialogflow\";\nimport uuid from \"uuid\";\nimport { default_agent } from \"../../Config/DialogFlow\";\nimport { shared_props } from \"../../Bot\";\n\nexport class DialogFlow {\n  constructor(Bot) {\n    this.Bot = Bot;\n    this.propsId = this.Bot.getId().origin;\n    this.initDialogFlowProps();\n\n    // selected agent\n    this.agent = default_agent;\n    this.projectId = this.agent.projectId;\n    this.config = this.agent.config;\n\n    // A unique identifier for the given session\n    this.sessionId = uuid.v4();\n\n    // Create a new session\n    this.sessionClient = new dialogflow.SessionsClient(this.config);\n    this.sessionPath = this.sessionClient.sessionPath(\n      this.projectId,\n      this.sessionId\n    );\n\n  }\n  \n  initDialogFlowProps(){\n    if (shared_props[this.propsId][\"dialogFlow\"] === undefined) {\n      shared_props[this.propsId][\"dialogFlow\"] = { isTalking: false };\n    }\n  }\n\n  getParameter(responses) {\n    const { fields } = responses[0].queryResult.parameters;\n    const { displayName } = responses[0].queryResult.intent;\n    const { allRequiredParamsPresent } = responses[0].queryResult;\n    return { displayName, fields, allRequiredParamsPresent };\n  }\n\n  getQuery(msg) {\n    const query = {\n      session: this.sessionPath,\n      queryInput: {\n        text: {\n          // The query to send to the dialogflow agent\n          text: msg,\n          // The language used by the client (en-US/id)\n          languageCode: \"id\"\n        }\n      }\n    };\n    return query;\n  }\n\n  chatGate(parameter, chatCallback) {\n    const { fields, displayName } = parameter;\n    if (\n      shared_props[this.propsId].dialogFlow.isTalking ||\n      displayName === \"chat.talk\"\n    ) {\n      if (Object.keys(fields).includes(\"chat\")) {\n        shared_props[this.propsId].dialogFlow.isTalking = JSON.parse(\n          fields.chat.stringValue\n        );\n      }\n      return chatCallback();\n    }\n  }\n\n  // Send request and log result\n  chat() {\n    return new Promise((resolve, reject) => {\n      try {\n        const { message } = this.Bot.props.event;\n        const query = this.getQuery(message.text);\n        this.sessionClient.detectIntent(query).then(responses => {\n          const parameter = this.getParameter(responses);\n\n          const { queryResult } = responses[0];\n          const { fulfillmentText } = queryResult;\n\n          const chatCallback = () => {\n            return resolve({ fulfillmentText, parameter });\n          };\n\n          // if (fulfillmentText.length >= 1) {\n          this.chatGate(parameter, chatCallback);\n          // }\n\n          console.log(\n            \"isTalking\",\n            shared_props[this.propsId].dialogFlow.isTalking\n          );\n          console.log(\"parameter\", JSON.stringify(parameter));\n          console.log(\"Detected intent\", responses[0].queryResult.displayName);\n          console.log(JSON.stringify(responses));\n        });\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n}\n"]}